# Создание крипто-материалов для Hyperledger Fabric

|-------------------------------------|
|         НАЧАЛО ГЕНЕРАЦИИ            |
|-------------------------------------|

1) Скопировать директорию `fabric`

- по образцу `org-example` подготовить данные в директории вида `org-[название организации]`
- Установить значение переменной окружения и экспортировать ее: 
`export ORG="org-[название организации]"`

2) В файле `project.properties` указать необходимые данные (описание в файле)

3) `./start-ca.sh` запустить удостоверяющие центры

4) `./enroll.sh` сгенерировать крипто-материалы

5) `./stop-ca.sh` остановить удостоверяющие центры

6) Крипто-материалы будут в директории: `${MOUNT_DIR}/${__CRYPTO_NAME__}`

7) Установить ограничение к директории крипто-материалов:
`chmod -R 0700` для директорий:
`${MOUNT_DIR}/crypto`
`${MOUNT_DIR}/fabca`

доступ к содержимому должен быть только владельцу-администратору, в fabca лежат приватные ключи

8) Скопировать данные из `${MOUNT_DIR}/crypto` на хосты пиров,
установить права доступа для крипто-материалов для пользователя, который запускает приложение

|-------------------------------------|
|         ЗАВЕРШЕНИЕ ГЕНЕРАЦИИ        |
|-------------------------------------|


дополнительно: 

`./hsm-list.sh` - список записей в hsm

--
деструктивные операции (clear) по умолчанию отключены
для включения в файле `project.properties` установить значение переменной `PRODUCTION=off`
--
логи серверов удостоверяющих центров: 
значения в переменных `__TLSCA_LOG__` и `__CA_LOG__` 
--

|-------------------------------------|
|        РАЗДЕЛ ДЛЯ РАЗРАБОТКИ        |
|-------------------------------------|
# Для разработки при использовании docker

1) Собрать образ build
2) make dev - запустить контейнер с удостоверяющими центрами (ca, tlsca)

#### Первичное создание крипто-материалов
3) `./enroll.sh`

#### Перевыпуск крипто-материалов (TODO в разработке)
3) `./reenroll.sh`

4) Скопировать крипто-материалы из контейнера в директорию ./crypto,
`./copy-crypto.sh`

--------
#### Первичная установка для docker:
Данные о точках монтирования в Makefile  

Создать docker volume для хранения постоянных данных crypto генератора  
docker volume create --driver local afsc-fabric-crypto-db  

Содать слот в softhsm:
```
softhsm2-util --init-token --slot 0 \
  --label "${ENV_HSM_SLOT}" \
  --pin "${ENV_HSM_PIN}" \
  --so-pin 1212
```
